<!DOCTYPE html>
<html>


<head>
  <meta charset="UTF-8">
  <title>Islamic star pattern generator</title>
  <script src="js/d3.v3.min.js" charset="utf-8"></script>
  <script src="js/export-svg.js"></script>
  <script src="js/geometry.js"></script>
  <script src="js/pattern.js"></script>
  <script src="js/shapes.js"></script>

  <style>
    #drawing,#controls {
      float: right;
      clear: right;
    }

    .upload-link input {
      display:none;
    }

    .upload-link {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }

    input[type=number] {
      width: 4em;
    }

    #s1value, #s2value {
      display: inline-block;
      width: 3em;
    }
  </style>

  </head>

<body>

<svg id="drawing" width="500" height="300"></svg>
<div id="controls">
  <div>
  Rows: <input type="number" id="rows" value="2" step="1"></input>
  Cols: <input type="number" id="cols" value="2" step="1"></input>
  </div>

  <div>
  Shape: <select id="shape">
    <option value="hex">Hexagons</option>
    <option value="oct">Octagons</option>
  </select>
  </div>
  

  <div><a download="pattern.svg" id="download">download svg</a></div>
  <div><a download="params.json" id="params">save parameters</a></div>
  <div>
    <label class="upload-link">
      <input type="file" name="load"></input>
      load parameters
      </label>
  </div>

  s1: <input type="range" id="s1" min="0" max="1" step=".01"/> <span id="s1value"></span>
  s2: <input type="range" id="s2" min="0" max="1" step=".01"/> <span id="s2value"></span>
</div>

<div id="delta-controls">
<pre>
/**
 * returns the distance between the endpoints.
 * tile    is the tile currently being drawn.
 *         use tile[0] and tile[1] to get the row and column
 * x and y are the (absolute) position of the point,
 *         scaled to the range [0,1]
 * typical outputs are in the range [0,1)
 */
function delta(tile,x,y) {
</pre>
&nbsp;&nbsp;<textarea id="delta" rows="5" cols="50" wrap="off">
var s1 = d3.select('#s1').node().value;
var s2 = d3.select('#s2').node().value;
//return Math.sin(Math.PI*y);
//return 0;
return s1;
</textarea>
<pre>
}
</pre>
</div>

<div id="theta-controls">
<pre>
/**
 * returns the angle between the edges.
 * tile    is the tile currently being drawn.
 *         use tile[0] and tile[1] to get the row and column
 * x and y are the (absolute) position of the point,
 *         scaled to the range [0,1]
 * typical outputs are in the range [0,Math.PI)
 */
function theta(tile,x,y) {
</pre>
&nbsp;&nbsp;<textarea id="theta"rows="5" cols="50" wrap="off">
var s1 = d3.select('#s1').node().value;
var s2 = d3.select('#s2').node().value;
// return 0.5+Math.PI/3*Math.sin(x*Math.PI);
// return Math.PI/3;
return s2*Math.PI;
</textarea>
<pre>
}
</pre>
</div>

<script>

var params = ['shape', 'rows', 'cols', 's1', 's2', 'delta', 'theta'];

function paramsAsLink() {
  var result = {};
  for (var i in params)
    result[params[i]] = d3.select('#' + params[i]).node().value;

  var data = encodeURIComponent(JSON.stringify(result,2));
  return "data:application/json;charset=utf-8," + data;
}

function loadParams(event) {
  var file = event.target.files[0];
  if (file == undefined) return;

  var reader = new FileReader();
  reader.onload = function (e) {
    var input = JSON.parse(e.target.result);
    for (var i in params)
      d3.select('#' + params[i]).node().value = input[params[i]];

    update();
  };

  reader.readAsText(file)
}

d3.select('#upload').on('change', loadParams);

var pattern = IslamicPattern();

function update() {

  var shape = null;

  switch(d3.select('#shape').node().value) {
    case 'hex': shape = hex; break;
    case 'oct': shape = oct; break;
  }

  pattern.points(shape.points);
  pattern.connections(shape.conn);

  var rows = d3.select('#rows').node().value;
  var cols = d3.select('#cols').node().value;

  tiles = [];
  for (var i = 0; i < rows; i++)
    for (var j = 0; j < cols; j++)
      tiles.push([i,j]);

  pattern.delta(new Function('tile','x','y',d3.select('#delta').node().value));
  pattern.theta(new Function('tile','x','y',d3.select('#theta').node().value));
  pattern.tiles(tiles);
  pattern.boundingBox(shape.bb(+rows,+cols));

  d3.select("#drawing").call(pattern);
  d3.select("#params").attr("href",paramsAsLink());
  d3.select("#download").attr("href", svgAsLink(d3.select("#drawing").node()))

  d3.select("#s1value").text(d3.select('#s1').node().value);
  d3.select("#s2value").text(d3.select('#s2').node().value);
  ;
}

update();

d3.selectAll('textarea,select').on('change',update);
d3.selectAll('input').on('input',update);

</script>

</body>

</html>


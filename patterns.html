<!DOCTYPE html>
<html>


<head>
  <meta charset="UTF-8">
  <title>Islamic star pattern generator</title>
  <script src="js/d3.v3.min.js" charset="utf-8"></script>
  <script src="js/export-svg.js"></script>
  <script src="js/geometry.js"></script>
  <script src="js/pattern.js"></script>

  <style>
    .upload-link input {
      display:none;
    }

    .upload-link {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }

    input[type=number] {
      width: 4em;
    }
  </style>

  </head>

<body>

<svg id="drawing" width="500" height="300"></svg>

<div>
<pre>
/**
 * returns the distance between the endpoints.
 * r and c are the row and column number of the tile.
 *         between 0 and numrows/numcols
 * x and y are the (absolute) position of the point,
 *         scaled to the range [0,1]
 * typical outputs are in the range [0,1)
 */
function delta(r,c,x,y) {
</pre>
&nbsp;&nbsp;<textarea id="delta"rows="5" cols="50">
return Math.sin(Math.PI*y);
</textarea>
<pre>
}
</pre>
</div>

<div>
<pre>
/**
 * returns the angle between the edges.
 * r and c are the row and column number of the tile.
 *         between 0 and numrows/numcols
 * x and y are the (absolute) position of the point,
 *         scaled to the range [0,1]
 * typical outputs are in the range [0,Math.PI)
 */
function theta(r,c,x,y) {
</pre>
&nbsp;&nbsp;<textarea id="theta"rows="5" cols="50">
return 0.5+Math.PI/3*Math.sin(x*Math.PI);
</textarea>
<pre>
}
</pre>
</div>

<div>
Rows: <input type="number" id="rows" value="10" step="1"></input>
Cols: <input type="number" id="cols" value="20" step="1"></input>
</div>

<div><a download="pattern.svg" id="download">download svg</a></div>
<div><a download="params.json" id="params">save parameters</a></div>
<div>
  <label class="upload-link">
    <input type="file" name="load"></input>
    load parameters
    </label>
</div>

<script>

/*       /
 *    1 /|            (0,2s)___(1,2s)                    .  .    .  .
 *     / | sin 60   (-c,s) /   \  (1+c, s)     |\       .    .  .    .
 *    /__|                 \___/               x  y      o  .    o  .
 *   cos 60              (0,0) (1,0)           |    \   .    o  .
 *                                                       o  .    o  .
 */

var c = Math.cos(Math.PI/3), s = Math.sin(Math.PI/3);
var shape = [[0,0], [1,0], [1+c, s], [1, 2*s], [0, 2*s], [-c,s]];

var x = [0, 2*s];
var y = [1+c, s];

/** positions: [0,0], [1,0], [2,-1], ... */
var positions = [];
for (var i = 0; i < 20; i++)
  for (var j = -Math.floor(i/2); j < 10 - Math.floor(i/2); j++)
    positions.push(add(smult(j, x), smult(i, y)));

var conn = [1,2,3,4,5,0];

function paramsAsLink() {
  var result = {
    deltaFun: d3.select('#delta').text(),
    thetaFun: d3.select('#theta').text(),
    rows:     d3.select('#rows').attr('value'),
    cols:     d3.select('#cols').attr('value')
  };

  var data = encodeURIComponent(JSON.stringify(result,2));
  return "data:application/json;charset=utf-8," + data;
}

function loadParams(event) {
  var file = event.target.files[0];
  if (file == undefined) return;

  var reader = new FileReader();
  reader.onload = function (e) {
    var input = JSON.parse(e.target.result);
    d3.select('#delta').text(input.deltaFun);
    d3.select('#theta').text(input.thetaFun);
    d3.select('#rows').attr('value',input.rows);
    d3.select('#cols').attr('value',input.cols);
    update();
  };

  reader.readAsText(file)
}

d3.select('#upload').on('change', loadParams);

var pattern = IslamicPattern();
pattern.shape(shape);
pattern.connections(conn);
pattern.offsets(positions);

function update() {

  pattern.delta(new Function('r','c','x','y',d3.select('#delta').text()));
  pattern.theta(new Function('r','c','x','y',d3.select('#theta').text()));
  pattern.rows(d3.select('#rows').attr('value'));
  pattern.cols(d3.select('#cols').attr('value'));

  d3.select("#drawing").call(pattern);
  d3.select("#params").attr("href",paramsAsLink());
}

update();

</script>

</body>

</html>

